name: Deploy Website

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # --------------------------------------------------
  # 1. テスト環境デプロイ (URL: .../test/index.html)
  # --------------------------------------------------
  deploy-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Test Directory
        run: |
          mkdir public
          mkdir public/test
          cp index.html public/test/

      - name: Upload Test Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages-test  # 名前を変えて衝突を防ぐ
          path: 'public'

      - name: Deploy to GitHub Pages (Test)
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages-test

  # --------------------------------------------------
  # 2. 本番環境デプロイ (URL: .../index.html)
  # --------------------------------------------------
  deploy-production:
    needs: deploy-test
    runs-on: ubuntu-latest
    environment:
      name: production # ★ここで承認待ちが発生します
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload Production Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages # 本番はデフォルト名を使用
          path: '.'

      - name: Deploy to GitHub Pages (Production)
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages
