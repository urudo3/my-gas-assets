name: Deploy Website

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # --------------------------------------------------
  # 1. テスト環境デプロイ (URL: .../test/index.html)
  # --------------------------------------------------
  deploy-test:
    runs-on: ubuntu-latest
    # ※ environment: github-pages を消すか、Settings側で承認設定がないことを確認
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Test Directory
        run: |
          mkdir public       # 公開用の親フォルダを作る
          mkdir public/test  # その中に test フォルダを作る
          cp index.html public/test/ # testの中にファイルをコピー

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'  # testフォルダが入っている「public」ごと送る

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  # --------------------------------------------------
  # 2. 本番環境デプロイ (URL: .../index.html)
  # --------------------------------------------------
  deploy-production:
    needs: deploy-test
    runs-on: ubuntu-latest
    environment:
      name: production # ★Settingsで承認設定をした環境
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # ここは「test」を通さないのでルート（本番）が更新される

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
